# Install virtual machine Bochs 2.7

## Install dependencies

```shell
sudo apt-get install nasm make build-essential libc6-dev xorg-dev libx11-dev  libreadline-dev libtool libltdl-dev libxpm-dev libxmu-dev libxext-dev libxrandr-dev libxinerama-dev libxv-dev libxcursor-dev libxt-dev libgtk2.0-dev zlib1g-dev libncurses5-dev libssl-dev libpci-dev libusb-dev  libvncserver-dev libjpeg-dev libpng-dev libgtkglext1-dev
```

## Download Bochs source code from the command line
* Manual
Official website link: https://sourceforge.net/projects/bochs/files/bochs/2.7/bochs-2.7.tar.gz/download

* Command

```shell
curl -o bochs.tar.gz https://zenlayer.dl.sourceforge.net/project/bochs/bochs/2.7/bochs-2.7.tar.gz
```

## Unzip

```shell
tar zxvf bochs.tar.gz
```

`tar` is a command used to unzip tar.gz files.

Explanation of each option:
- `tar` is the tar command.
- `z` indicates that it needs to be decompressed with gzip.
- `x` indicates that the file should be extracted.
- `v` indicates that the extraction process should be displayed in detail.
- `f` indicates that the filename to be extracted follows as the next parameter, which is `bochs.tar.gz` in this case.

Therefore, running the `tar zxvf bochs.tar.gz` command will extract the `bochs.tar.gz` file to the current directory.


## Enter the extracted directory

> cd bochs-2.7

## Installation

* Step 1: Configure

    ```shell
    ./configure --prefix=/home/mjd/osx64/bochs --with-x11 --with-wx --enable-debugger --enable-all-optimizations --enable-readline \
    --enable-long-phy-address --enable-ltdl-install --enable-idle-hack --enable-a20-pin --enable-x86-64 --enable-smp --enable-cpu-level=6 \
    --enable-large-ramfile --enable-repeat-speedups --enable-fast-function-calls  --enable-handlers-chaining  --enable-trace-linking \
    --enable-configurable-msrs --enable-show-ips --enable-cpp --enable-debugger-gui --enable-iodebug --enable-logging --enable-assert-checks \
    --enable-fpu --enable-vmx=2 --enable-svm --enable-3dnow --enable-alignment-check  --enable-monitor-mwait --enable-avx \
    --enable-evex --enable-x86-debugger --enable-pci --enable-usb --enable-e1000 --enable-voodoo --enable-raw-serial
    ```
    This step is for configuration, generally used to generate `Makefile` and prepare for the next step of compilation. You can control the installation by adding parameters after `configure`. For example: `./configure --prefix=/usr` means installing the software under `/usr`, where the executable files will be installed in `/usr/bin`, and resource files will be installed in `/usr/share`. If no `--prefix` is used to specify a path, the default paths are as follows:  
    
    - Executable files will be placed in `/usr/local/bin`.
    - Library files will be placed in `/usr/local/lib`.
    - Configuration files will be placed in `/usr/local/etc`.
    - Resource files will be placed in `/usr/local/share`.  

* Step 2: Fixing a compilation bug (issue from the author of Bochs)

1. First, execute the following commands:
    ```shell
    cp misc/bximage.cpp misc/bximage.cc
    cp misc/bxhub.cpp misc/bxhub.cc
    cp iodev/hdimage/hdimage.cpp iodev/hdimage/hdimage.cc
    cp iodev/hdimage/vmware3.cpp iodev/hdimage/vmware3.cc
    cp iodev/hdimage/vmware4.cpp iodev/hdimage/vmware4.cc
    cp iodev/hdimage/vbox.cpp iodev/hdimage/vbox.cc
    cp iodev/hdimage/vpc.cpp iodev/hdimage/vpc.cc
    cp iodev/network/netutil.cpp iodev/network/netutil.cc
    ```
2. Then, modify the header file inclusion in the file `bochs-2.7/bx_debug/debug.h` as follows:
    ```shell
    (line 25) #include "config.h"
    (line 26) #include "osdep.h"
    (line 34) #include "cpu/decoder/decoder.h"
    ```
    Modify to:
    ```shell
    (line 25) #include "../config.h"
    (line 26) #include "../osdep.h"
    (line 34) #include "../cpu/decoder/decoder.h"
    ```

* Step 3: Compilation and installation

```shell
make
make install
```

* Step 4: Testing

Navigate to the `bochs/bin` directory.

Copy the following files to that directory: `boot.bin` and `sample_bochsrc`.

Then execute the command:

```shell
./bochs -f ./sample_bochsrc
# Press 'c' to continue execution
```