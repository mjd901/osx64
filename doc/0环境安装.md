# 安装虚拟机Bochs2.7

## 安装依赖

```shell
sudo apt-get install nasm make build-essential libc6-dev xorg-dev libx11-dev  libreadline-dev libtool libltdl-dev libxpm-dev libxmu-dev libxext-dev libxrandr-dev libxinerama-dev libxv-dev libxcursor-dev libxt-dev libgtk2.0-dev zlib1g-dev libncurses5-dev libssl-dev libpci-dev libusb-dev  libvncserver-dev libjpeg-dev libpng-dev libgtkglext1-dev
```

## 命令行下载bochs源码
* 手动
官网链接：https://sourceforge.net/projects/bochs/files/bochs/2.7/bochs-2.7.tar.gz/download

* 命令

```shell
curl -o bochs.tar.gz https://zenlayer.dl.sourceforge.net/project/bochs/bochs/2.7/bochs-2.7.tar.gz
```


## 解压

```shell
tar zxvf bochs.tar.gz
```

`tar`是一个用于解压缩tar.gz文件的命令。

解释一下每个选项的含义：
- `tar` 是tar命令；
- `z` 表示需要通过gzip进行解压缩；
- `x` 表示要解压缩文件；
- `v` 表示显示详细的解压缩过程；
- `f` 表示要解压缩的文件名是接下来的参数，即bochs.tar.gz。

因此，运行`tar zxvf bochs.tar.gz`命令会将bochs.tar.gz文件解压缩到当前目录。


## 进入解压目录

> cd bochs-2.7

## 安装

* 第一步configure

    ```shell
    ./configure --prefix=/home/mjd/osx64/bochs --with-x11 --with-wx --enable-debugger --enable-all-optimizations --enable-readline \
    --enable-long-phy-address --enable-ltdl-install --enable-idle-hack --enable-a20-pin --enable-x86-64 --enable-smp --enable-cpu-level=6 \
    --enable-large-ramfile --enable-repeat-speedups --enable-fast-function-calls  --enable-handlers-chaining  --enable-trace-linking \
    --enable-configurable-msrs --enable-show-ips --enable-cpp --enable-debugger-gui --enable-iodebug --enable-logging --enable-assert-checks \
    --enable-fpu --enable-vmx=2 --enable-svm --enable-3dnow --enable-alignment-check  --enable-monitor-mwait --enable-avx \
    --enable-evex --enable-x86-debugger --enable-pci --enable-usb --enable-e1000 --enable-voodoo --enable-raw-serial
    ```

    这一步是配置，一般用来生成 `Makefile`，为下一步的编译做准备，可以通过在`configure` 后加上参数来对安装进行控制
    比如代码:`./configure --prefix=/usr` 意思是将该软件安装在 `/usr`下面，执行文件就会安装在 `/usr/bin` ，资源文件就会安装在 `/usr/share`，如果没有使用`--prefix`指定路径那么都是走默认路径:
    * 可执行文件默认放在/usr/local/bin中
    * 库文件默认放在/usr/local/lib中
    * 配置文件默认放在/usr/local/etc中
    * 资源文件默认放在/usr/local/share中


* 第二步 提前解决编译bug（bochs的作者的问题）

  1.首先执行
    ```shell
    cp misc/bximage.cpp misc/bximage.cc
    cp misc/bxhub.cpp misc/bxhub.cc
    cp iodev/hdimage/hdimage.cpp iodev/hdimage/hdimage.cc
    cp iodev/hdimage/vmware3.cpp iodev/hdimage/vmware3.cc
    cp iodev/hdimage/vmware4.cpp iodev/hdimage/vmware4.cc
    cp iodev/hdimage/vbox.cpp iodev/hdimage/vbox.cc
    cp iodev/hdimage/vpc.cpp iodev/hdimage/vpc.cc
    cp iodev/network/netutil.cpp iodev/network/netutil.cc
    ```
  2.然后修改`bochs-2.7/bx_debug/debug.h`文件的头文件
  ```shell
  （行号25）#include "config.h"
  （行号26）#include "osdep.h"
  （行号34）#include "cpu/decoder/decoder.h"
  ```
  修改后为
  ```shell
  （行号25）#include "../config.h"
  （行号26）#include "../osdep.h"
  （行号34）#include "../cpu/decoder/decoder.h"
  ```
* 第二步 编译安装

```
make
make install
```

* 第三步 测试

进入bochs/bin目录下

将以下文件拷贝到该目录下：`boot.bin` 以及 `sample_bochsrc`

然后执行命令

```shell
./bochs -f ./sample_bochsrc
#接着输入c继续执行
```

注意修改`sample_bochsrc`里面的配置
1.修改第五行和第六行，将path修改为bochs/share/BIOS-bochs-latest和bochs/share/VGABIOS-lgpl-latest的绝对路径或者相对路径
